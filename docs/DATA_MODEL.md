# Data Model

> Defines the JSON data contracts between the pipeline (`scripts/`) and the frontend (`site/`).

## Data Files

All files live in `site/data/` and are generated by `scripts/pipeline/` (entry point: `scripts/fetch_data.py`).

| File | Description | Time-filtered |
|------|-------------|:---:|
| `metadata.json` | Match counts, player counts, timestamps | Yes |
| `commander_stats.json` | Per-commander winrate, matches, wins | Yes |
| `matchups.json` | Commander-vs-commander winrate matrix | Yes |
| `card_stats.json` | Per-card play/draw/deck rates and winrates | Yes |
| `commander_card_stats.json` | Per-commander card inclusion, winrates, copies (lazy-loaded) | Yes |
| `trends.json` | Weekly faction popularity percentages | Yes |
| `commander_trends.json` | Weekly per-commander popularity percentages | Yes |
| `commander_winrate_trends.json` | Weekly per-commander winrate (with/without mirrors) | Yes |
| `game_distributions.json` | Duration, turns, actions histograms | Yes |
| `deck_composition.json` | Per-commander deck cost, type ratios, loyalty | Yes |
| `duration_winrates.json` | Per-commander winrate by game duration buckets | Yes |
| `action_winrates.json` | Per-commander winrate by action-count buckets | Yes |
| `turn_winrates.json` | Per-commander winrate by turn-count buckets | Yes |
| `first_turn.json` | First-turn advantage stats, overall and per-commander | Yes |
| `cards.json` | Card definitions from CSV (reference data) | No |
| `commanders.json` | Commander definitions from CSV (reference data) | No |

## Time Period Nesting

Stats files are doubly nested by time period and map. The frontend reads `data[period][map]` where period is one of `all`, `6m`, `3m`, `1m` and map is one of `all`, `Dunes`, `Snowmelt`, `Tropics`.

```json
{
  "all": {
    "all": <full data>,
    "Dunes": <dunes only>,
    "Snowmelt": <snowmelt only>,
    "Tropics": <tropics only>
  },
  "6m": { "all": ..., "Dunes": ..., ... },
  "3m": { ... },
  "1m": { ... }
}
```

Reference files (`cards.json`, `commanders.json`) are flat arrays — no period/map nesting.

## Schema Definitions

### metadata.json
```json
{
  "all": {
    "last_updated": "2026-02-22T06:00:00Z",
    "total_matches": 3104,
    "total_players": 202,
    "data_version": "2.0.0"
  },
  "6m": { ... },
  "3m": { ... },
  "1m": { ... }
}
```

### commander_stats.json
```json
{
  "all": [
    {
      "name": "Jagris, the Huntsman",
      "faction": "grenalia",
      "matches": 983,
      "wins": 590,
      "winrate": 0.6002
    }
  ],
  "6m": [ ... ],
  "3m": [ ... ],
  "1m": [ ... ]
}
```

### matchups.json
```json
{
  "all": {
    "commanders": ["Captain Greenbeard", "Elber, Jungle Emissary", ...],
    "matchups": [
      {
        "commander": "Captain Greenbeard",
        "opponent": "Elber, Jungle Emissary",
        "wins": 45,
        "losses": 38,
        "total": 83,
        "winrate": 0.5422
      }
    ]
  },
  "6m": { ... },
  "3m": { ... },
  "1m": { ... }
}
```

### card_stats.json
```json
{
  "all": {
    "all": [
      {
        "name": "Fireball",
        "faction": "neutral",
        "type": "Spell",
        "deck_count": 1200,
        "deck_rate": 0.1932,
        "deck_winrate": 0.5100,
        "drawn_count": 800,
        "drawn_rate": 0.1288,
        "drawn_winrate": 0.5250,
        "played_count": 600,
        "played_rate": 0.0966,
        "played_winrate": 0.5400,
        "avg_copies": 2.64,
        "drawn_instances": 1450,
        "played_instances": 980
      }
    ]
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `deck_count` | int | Number of decks containing this card |
| `deck_rate` | float | `deck_count / total_player_games` |
| `drawn_count` | int | Number of games where this card was drawn |
| `drawn_instances` | int | Total copies drawn (counts each copy separately) |
| `played_count` | int | Number of games where this card was played |
| `played_instances` | int | Total copies played (counts each copy separately) |
| `avg_copies` | float | `total_copies / deck_count` — average copies per deck that includes it |

### commander_card_stats.json

Lazy-loaded on first commander selection. Nested `data[period][map][commander_name]` → array of card objects sorted by inclusion rate (all cards, no limit).

```json
{
  "all": {
    "all": {
      "Fael Spiritwalker": [
        {
          "name": "Killing Hex",
          "inclusion_rate": 0.9415,
          "drawn_rate": 0.7018,
          "drawn_winrate": 0.4833,
          "played_rate": 0.5789,
          "played_winrate": 0.4798,
          "drawn_count": 240,
          "played_count": 198,
          "drawn_instances": 424,
          "played_instances": 312,
          "avg_copies": 2.87,
          "deck_count": 322,
          "games": 342
        }
      ]
    }
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `inclusion_rate` | float | `deck_count / games` for this commander |
| `games` | int | Total games played with this commander (denominator for all rates) |
| `deck_count` | int | Number of this commander's decks containing the card |
| `avg_copies` | float | Average copies in decks that include it |

### trends.json
```json
{
  "all": {
    "dates": ["2025-W40", "2025-W41", ...],
    "factions": {
      "skaal": [22.5, 23.1, ...],
      "grenalia": [18.0, 17.5, ...],
      "lucia": [20.0, 21.0, ...],
      "neutral": [15.0, 14.5, ...],
      "shadis": [12.0, 12.5, ...],
      "archaeon": [12.5, 11.4, ...]
    }
  },
  "6m": { ... },
  "3m": { ... },
  "1m": { ... }
}
```

### game_distributions.json
```json
{
  "all": {
    "duration": {
      "labels": ["0-2", "2-4", "4-6", ...],
      "counts": [44, 157, 318, ...],
      "total": 3104
    },
    "turns": {
      "labels": ["0-2", "2-4", "4-6", ...],
      "counts": [12, 85, 220, ...],
      "total": 3104
    },
    "actions": {
      "labels": ["0-20", "20-40", "40-60", ...],
      "counts": [95, 310, 480, ...],
      "total": 3104
    }
  },
  "6m": { ... },
  "3m": { ... },
  "1m": { ... }
}
```

### deck_composition.json
```json
{
  "all": {
    "Jagris, the Huntsman": {
      "faction": "grenalia",
      "deck_count": 983,
      "avg_cost": 3.42,
      "cost_histogram": {
        "labels": ["0", "1", "2", ..., "12+"],
        "all_decks": [0.5, 2.1, 8.3, ...],
        "winning_decks": [0.5, 2.0, 8.1, ...],
        "losing_decks": [0.5, 2.2, 8.5, ...]
      },
      "avg_minion_count": 28.5,
      "avg_spell_count": 12.3,
      "avg_patron_cards": 18.2,
      "avg_neutral_cards": 20.8,
      "avg_other_cards": 1.8,
      "win_avg_minion_count": 28.8,
      "win_avg_spell_count": 12.1,
      "loss_avg_minion_count": 28.2,
      "loss_avg_spell_count": 12.5
    }
  },
  "6m": { ... },
  "3m": { ... },
  "1m": { ... }
}
```

### duration_winrates.json / action_winrates.json / turn_winrates.json

All three share the same structure — per-commander winrate broken into buckets.

```json
{
  "all": {
    "all": {
      "buckets": ["0-10", "10-20", "20-30", "30+"],
      "commanders": {
        "Jagris, the Huntsman": [
          { "winrate": 0.5714, "games": 98 },
          { "winrate": 0.5200, "games": 150 },
          { "winrate": 0.4800, "games": 75 },
          { "winrate": 0.4000, "games": 30 }
        ]
      }
    }
  }
}
```

Bucket labels differ per file:
- **duration**: `["0-10", "10-20", "20-30", "30+"]` (minutes)
- **actions**: `["0-30", "30-60", "60-90", "90-120", "120+"]`
- **turns**: `["1-5", "5-8", "8-11", "11-14", "14+"]`

Each commander has one `{ winrate, games }` entry per bucket. `winrate` is null when games = 0.

### first_turn.json
```json
{
  "all": {
    "all": {
      "total_games": 1787,
      "first_player_wins": 926,
      "first_player_winrate": 0.5182,
      "per_commander": {
        "Elber, Jungle Emissary": {
          "first_games": 169,
          "first_wins": 96,
          "first_winrate": 0.568,
          "second_games": 181,
          "second_wins": 88,
          "second_winrate": 0.4862
        }
      }
    }
  }
}
```

### commander_trends.json
```json
{
  "all": {
    "all": {
      "dates": ["2023-W29", "2023-W30", "2023-W31"],
      "commanders": {
        "Macks Speed": [16.7, 2.4, 8.8]
      }
    }
  }
}
```

Each commander maps to an array of weekly popularity percentages aligned with `dates`.

### commander_winrate_trends.json
```json
{
  "all": {
    "all": {
      "dates": ["2023-W29", "2023-W30", "2023-W31"],
      "commanders": {
        "Macks Speed": {
          "winrate": [50.0, 66.7, null],
          "games": [4, 3, 0],
          "winrate_no_mirror": [52.1, 60.0, null],
          "games_no_mirror": [3, 2, 0]
        }
      }
    }
  }
}
```

Each commander has four parallel arrays aligned with `dates`:
- `winrate` / `games`: all games including mirrors. `null` when commander had 0 games that week.
- `winrate_no_mirror` / `games_no_mirror`: excluding games where both players used the same commander.

### cards.json (flat — no period nesting)
```json
[
  {
    "name": "Fireball",
    "type": "Spell",
    "text": "Deal 3 damage to a character.",
    "subtype": "",
    "cost": 3,
    "attack": null,
    "speed": null,
    "health": null,
    "legendary": false,
    "faction": "neutral",
    "art": "CardScreenshots/Fireball.png"
  }
]
```

### commanders.json (flat — no period nesting)
```json
[
  {
    "name": "Jagris, the Huntsman",
    "text": "[Range 2, Cooldown 2]: A minion gains +1/+1/+1.",
    "subtype": "Human",
    "dominion": 5,
    "intellect": 6,
    "speed": 1,
    "health": 30,
    "faction": "grenalia",
    "art": "assets/commanders/jagris-the-huntsman.jpg"
  }
]
```

## Factions

Six factions with colorblind-safe Okabe-Ito colors:

| Faction | Key | Color |
|---------|-----|-------|
| Skaal | `skaal` | `#D55E00` |
| Grenalia | `grenalia` | `#009E73` |
| Lucia | `lucia` | `#E8B630` |
| Neutral | `neutral` | `#A89078` |
| Shadis | `shadis` | `#7B7B8E` |
| Archaeon | `archaeon` | `#0072B2` |
